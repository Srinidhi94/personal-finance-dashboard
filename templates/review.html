{% extends "base.html" %}

{% block title %}Review Transactions - Smart Expense Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Review Transactions</h2>
    <a href="/" class="btn btn-outline-primary">Back to Dashboard</a>
</div>

<div class="alert alert-info">
    <p>Review and correct the categories for these transactions. The system will learn from your corrections.</p>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Account</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr data-id="{{ batch_id + loop.index0 }}">
                        <td>{{ transaction.date }}</td>
                        <td>
                            <div class="description-display" style="max-width: 300px; word-wrap: break-word;">
                                {{ transaction.description }}
                            </div>
                            <div class="description-edit" style="display: none;">
                                <input type="text" class="form-control form-control-sm" value="{{ transaction.description }}" />
                            </div>
                        </td>
                        <td>
                            <span class="{% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if transaction.amount > 0 %}
                                    ₹{{ "{:,.2f}".format(transaction.amount) }}
                                {% else %}
                                    -₹{{ "{:,.2f}".format(transaction.amount|abs) }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark category-display" data-id="{{ batch_id + loop.index0 }}">
                                {{ transaction.category }}
                            </span>
                            <select class="form-select form-select-sm category-select" style="display: none;" data-id="{{ batch_id + loop.index0 }}">
                                {% for category in categories %}
                                <option value="{{ category }}" {% if category == transaction.category %}selected{% endif %}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <span class="badge text-bg-{% if transaction.account_type == 'credit_card' %}danger{% else %}success{% endif %}">
                                {{ transaction.account_name }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ batch_id + loop.index0 }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success save-btn" data-id="{{ batch_id + loop.index0 }}" style="display: none;">
                                <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary cancel-btn" data-id="{{ batch_id + loop.index0 }}" style="display: none;">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-4">
            <a href="/" class="btn btn-success">Finish Review</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Handle edit transaction
    const editButtons = document.querySelectorAll('.edit-btn');
    const saveButtons = document.querySelectorAll('.save-btn');
    const cancelButtons = document.querySelectorAll('.cancel-btn');
    const categoryDisplays = document.querySelectorAll('.category-display');
    const categorySelects = document.querySelectorAll('.category-select');
    
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const row = this.closest('tr');
            
            // Hide display elements, show edit elements
            document.querySelector(`.category-display[data-id="${id}"]`).style.display = 'none';
            document.querySelector(`.category-select[data-id="${id}"]`).style.display = 'block';
            row.querySelector('.description-display').style.display = 'none';
            row.querySelector('.description-edit').style.display = 'block';
            
            // Hide edit button, show save and cancel buttons
            this.style.display = 'none';
            document.querySelector(`.save-btn[data-id="${id}"]`).style.display = 'inline-block';
            document.querySelector(`.cancel-btn[data-id="${id}"]`).style.display = 'inline-block';
        });
    });
    
    saveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const row = this.closest('tr');
            const select = document.querySelector(`.category-select[data-id="${id}"]`);
            const newCategory = select.value;
            const descriptionInput = row.querySelector('.description-edit input');
            const newDescription = descriptionInput.value;
            
            // Send update to server
            fetch('/update_transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    transaction_idx: parseInt(id),
                    category: newCategory,
                    description: newDescription
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update display
                    const categoryDisplay = document.querySelector(`.category-display[data-id="${id}"]`);
                    categoryDisplay.textContent = newCategory;
                    
                    const descriptionDisplay = row.querySelector('.description-display');
                    descriptionDisplay.textContent = newDescription || 'No description';
                    
                    // Show display elements, hide edit elements
                    categoryDisplay.style.display = 'inline-block';
                    select.style.display = 'none';
                    descriptionDisplay.style.display = 'block';
                    row.querySelector('.description-edit').style.display = 'none';
                    
                    // Show edit button, hide save and cancel buttons
                    document.querySelector(`.edit-btn[data-id="${id}"]`).style.display = 'inline-block';
                    document.querySelector(`.save-btn[data-id="${id}"]`).style.display = 'none';
                    document.querySelector(`.cancel-btn[data-id="${id}"]`).style.display = 'none';
                }
            });
        });
    });
    
    cancelButtons.forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const row = this.closest('tr');
            
            // Show display elements, hide edit elements
            document.querySelector(`.category-display[data-id="${id}"]`).style.display = 'inline-block';
            document.querySelector(`.category-select[data-id="${id}"]`).style.display = 'none';
            row.querySelector('.description-display').style.display = 'block';
            row.querySelector('.description-edit').style.display = 'none';
            
            // Show edit button, hide save and cancel buttons
            document.querySelector(`.edit-btn[data-id="${id}"]`).style.display = 'inline-block';
            document.querySelector(`.save-btn[data-id="${id}"]`).style.display = 'none';
            document.querySelector(`.cancel-btn[data-id="${id}"]`).style.display = 'none';
        });
    });
    
    // Double-click to edit description
    document.querySelectorAll('.description-display').forEach(display => {
        display.addEventListener('dblclick', function() {
            const row = this.closest('tr');
            const id = row.getAttribute('data-id');
            
            // Toggle to edit mode
            this.style.display = 'none';
            row.querySelector('.description-edit').style.display = 'block';
            
            // If not already in edit mode, switch to it
            if (document.querySelector(`.edit-btn[data-id="${id}"]`).style.display !== 'none') {
                document.querySelector(`.edit-btn[data-id="${id}"]`).click();
            }
        });
    });
</script>
{% endblock %}